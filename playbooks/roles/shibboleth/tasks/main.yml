---
- name: check if sp-key.pem exist
  stat:
    path: /etc/shibboleth/sp-key.pem
  register: sp_key

- name: check if sp-cert.pem exist
  stat:
    path: /etc/shibboleth/sp-cert.pem
  register: sp_cert

- include: selfsigned.yml
  when: "(not sp_key.stat.exists) or (not sp_cert.stat.exists)"

- name: Configuring shibboleth2.xml
  template: 
    src: shibboleth2.xml
    dest: /etc/shibboleth/shibboleth2.xml
    group: _shibd
    owner: _shibd
    mode: 0644
  notify: restart shibd

- name: Checking, ( or if not present), Creating /etc/shibboleth/metadata directory
  file: 
    path: /etc/shibboleth/metadata
    state: directory
    mode: 2774
    group: _shibd
    owner: _shibd

- name: Downloading metadata into metadata directory as backup
  get_url:
    url: "{{ SHIB_METADATA_BACKUP_URL }}"
    dest: /etc/shibboleth/metadata/idp-metadata.xml
    mode: 0640
    group: _shibd
    owner: _shibd
  when: SHIB_DOWNLOAD_METADATA